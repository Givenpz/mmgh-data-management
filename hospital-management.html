<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mtendere Mission General Hospital - Data Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-dark: #1e3a6b;
            --secondary: #198754;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f4f8;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-box p {
            color: var(--gray);
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-form input, .login-form select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .login-form input:focus, .login-form select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .password-group {
            position: relative;
            display: flex;
            gap: 0;
        }

        .password-group input {
            flex: 1;
            border-radius: 5px 0 0 5px;
        }

        .password-toggle {
            padding: 12px 12px;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 5px 5px 0;
            background: #f8f9fa;
            color: var(--gray);
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
        }

        .password-toggle:hover {
            background: #e9ecef;
            color: var(--primary);
        }

        .login-btn {
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: var(--primary-dark);
        }

        #mainApp {
            display: none;
        }

        #mainApp.show {
            display: block;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 0;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .logo span {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .user-info span {
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background-color: #f0f7ff;
        }
        
        .tab.active {
            background-color: #e8f1ff;
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }

        .tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #157347;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #bb2d3b;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background-color: #f0f7ff;
            color: var(--primary);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e7ff;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f8fbff;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .edit-btn {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .edit-btn:hover {
            background-color: #ffeaa7;
        }

        .edit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .delete-btn {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .delete-btn:hover {
            background-color: #f5c2c7;
        }

        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .view-btn {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .view-btn:hover {
            background-color: #bee5eb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-icon.patients {
            background: linear-gradient(135deg, #4e54c8, #8f94fb);
        }
        
        .stat-icon.appointments {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        
        .stat-icon.staff {
            background: linear-gradient(135deg, #f46b45, #eea849);
        }
        
        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--gray);
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid #eaeaea;
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .search-box input {
            padding-left: 45px;
        }
        
        .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status.active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <i class="fas fa-hospital-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h1>MMGH Hospital</h1>
            <p>Data Management System</p>
            <form id="loginForm" class="login-form">
                <input type="text" id="loginUsername" placeholder="Username" required>
                <select id="loginRole" required>
                    <option value="">Select Role</option>
                    <option value="admin">Administrator</option>
                    <option value="staff">Staff Member</option>
                </select>
                <div class="password-group">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button type="submit" class="login-btn">Login</button>
                <button type="button" class="login-btn" style="background: var(--secondary); margin-top: 10px;" onclick="toggleSignup()">
                    Create Account
                </button>
            </form>
            <p style="margin-top: 20px; font-size: 0.9rem; color: var(--gray);">
                Demo: Use username "admin" or "staff" with any password
            </p>
        </div>
    </div>

    <!-- Sign Up Page -->
    <div id="signupPage" class="login-container" style="display: none;">
        <div class="login-box">
            <i class="fas fa-user-plus" style="font-size: 3rem; color: var(--secondary); margin-bottom: 20px;"></i>
            <h1>Create Account</h1>
            <p>Register to access MMGH System</p>
            <form id="signupForm" class="login-form">
                <input type="text" id="signupUsername" placeholder="Username" required>
                <input type="email" id="signupEmail" placeholder="Email Address" required>
                <input type="text" id="signupFullName" placeholder="Full Name" required>
                <select id="signupRole" required>
                    <option value="">Select Role</option>
                    <option value="admin">Administrator</option>
                    <option value="staff">Staff Member</option>
                </select>
                <div class="password-group">
                    <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" required minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="password-group">
                    <input type="password" id="signupConfirm" placeholder="Confirm Password" required minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupConfirm')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button type="submit" class="login-btn">Sign Up</button>
                <button type="button" class="login-btn" style="background: var(--gray); margin-top: 10px;" onclick="toggleSignup()">
                    Back to Login
                </button>
            </form>
            <p style="margin-top: 20px; font-size: 0.85rem; color: var(--gray); text-align: left;">
                <strong>Note:</strong> After registration, your account will be pending admin approval. You'll receive an email once approved.
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp">
        <header>
            <div class="container header-content">
                <div class="logo">
                    <i class="fas fa-hospital-alt"></i>
                    <div>
                        <h1>Mtendere Mission General Hospital</h1>
                        <span>Data Management System</span>
                    </div>
                </div>
                <div class="user-info">
                    <i class="fas fa-user-md"></i>
                    <div>
                        <strong id="currentUserName">Administrator</strong>
                        <div id="currentUserRole"></div>
                        <span class="role-badge" id="roleDisplay">Admin</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>
    
    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon patients">
                    <i class="fas fa-user-injured"></i>
                </div>
                <div class="stat-info">
                    <h3 id="patientCount">0</h3>
                    <p>Total Patients</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon appointments">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                    <h3 id="appointmentCount">0</h3>
                    <p>Today's Appointments</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon staff">
                    <i class="fas fa-user-nurse"></i>
                </div>
                <div class="stat-info">
                    <h3 id="staffCount">0</h3>
                    <p>Medical Staff</p>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="patients">
                <i class="fas fa-user-injured"></i> Patients
            </div>
            <div class="tab" data-tab="appointments">
                <i class="fas fa-calendar-check"></i> Appointments
            </div>
            <div class="tab" data-tab="medical-records">
                <i class="fas fa-file-medical"></i> Medical Records
            </div>
            <div class="tab" data-tab="staff">
                <i class="fas fa-user-nurse"></i> Staff
            </div>
            <div id="adminTabContainer" class="tab" data-tab="admin" style="display: none;">
                <i class="fas fa-cog"></i> Admin Panel
            </div>
        </div>
        
        <!-- Patients Tab -->
        <div id="patients" class="tab-content active">
            <div class="section-title">
                <h2><i class="fas fa-user-injured"></i> Patient Management</h2>
                <button class="btn btn-primary" id="addPatientBtn">
                    <i class="fas fa-plus"></i> Add New Patient
                </button>
            </div>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchPatient" placeholder="Search patients by name, ID, or phone number...">
            </div>
            
            <div class="table-responsive">
                <table id="patientsTable">
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Full Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patientsTableBody">
                        <!-- Patient data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Appointments Tab -->
        <div id="appointments" class="tab-content">
            <div class="section-title">
                <h2><i class="fas fa-calendar-check"></i> Appointment Management</h2>
                <button class="btn btn-primary" id="addAppointmentBtn">
                    <i class="fas fa-plus"></i> Schedule Appointment
                </button>
            </div>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchAppointment" placeholder="Search appointments by patient name, doctor, or date...">
            </div>
            
            <div class="table-responsive">
                <table id="appointmentsTable">
                    <thead>
                        <tr>
                            <th>Appointment ID</th>
                            <th>Patient Name</th>
                            <th>Doctor</th>
                            <th>Date & Time</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <!-- Appointment data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Medical Records Tab -->
        <div id="medical-records" class="tab-content">
            <div class="section-title">
                <h2><i class="fas fa-file-medical"></i> Medical Records</h2>
                <button class="btn btn-primary" id="addRecordBtn">
                    <i class="fas fa-plus"></i> Add Medical Record
                </button>
            </div>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchRecord" placeholder="Search records by patient name, diagnosis, or doctor...">
            </div>
            
            <div class="table-responsive">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>Record ID</th>
                            <th>Patient Name</th>
                            <th>Diagnosis</th>
                            <th>Doctor</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <!-- Medical record data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Staff Tab -->
        <div id="staff" class="tab-content">
            <div class="section-title">
                <h2><i class="fas fa-user-nurse"></i> Staff Management</h2>
                <button class="btn btn-primary" id="addStaffBtn">
                    <i class="fas fa-plus"></i> Add Staff Member
                </button>
            </div>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchStaff" placeholder="Search staff by name, department, or role...">
            </div>
            
            <div class="table-responsive">
                <table id="staffTable">
                    <thead>
                        <tr>
                            <th>Staff ID</th>
                            <th>Full Name</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                        <!-- Staff data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin" class="tab-content">
            <div class="section-title">
                <h2><i class="fas fa-cog"></i> Administration Panel</h2>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                <button class="btn btn-primary" onclick="switchAdminTab('pending-users')" id="pendingUsersBtn">
                    <i class="fas fa-user-clock"></i> Pending Approvals
                </button>
                <button class="btn btn-primary" onclick="switchAdminTab('user-management')">
                    <i class="fas fa-users-cog"></i> User Management
                </button>
                <button class="btn btn-primary" onclick="switchAdminTab('audit-logs')">
                    <i class="fas fa-history"></i> Audit Logs
                </button>
            </div>

            <!-- Pending Users Section -->
            <div id="pendingUsersSection" class="admin-section">
                <h3>Pending User Approvals</h3>
                <div id="pendingUsersList" style="margin-top: 20px;"></div>
            </div>

            <!-- User Management Section -->
            <div id="userManagementSection" class="admin-section" style="display: none;">
                <h3>All Users</h3>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchUsers" placeholder="Search users...">
                </div>
                <table id="usersTable" style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Full Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>

            <!-- Audit Logs Section -->
            <div id="auditLogsSection" class="admin-section" style="display: none;">
                <h3>Activity Logs</h3>
                <div style="margin-top: 20px; max-height: 600px; overflow-y: auto;">
                    <table id="auditTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Patient Modal -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-injured"></i> <span id="patientModalTitle">Add New Patient</span></h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientId">Patient ID</label>
                            <input type="text" id="patientId" value="MMGH-P-" readonly>
                        </div>
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dob">Date of Birth *</label>
                            <input type="date" id="dob" required>
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender *</label>
                            <select id="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number *</label>
                            <input type="tel" id="phone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="address">Address</label>
                            <textarea id="address" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="emergencyContact">Emergency Contact</label>
                            <input type="text" id="emergencyContact">
                        </div>
                        <div class="form-group">
                            <label for="bloodGroup">Blood Group</label>
                            <select id="bloodGroup">
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="patientEditIndex">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger close-modal">Cancel</button>
                <button type="submit" form="patientForm" class="btn btn-success">Save Patient</button>
            </div>
        </div>
    </div>
    
    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> <span id="appointmentModalTitle">Schedule Appointment</span></h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentId">Appointment ID</label>
                            <input type="text" id="appointmentId" value="MMGH-A-" readonly>
                        </div>
                        <div class="form-group">
                            <label for="appointmentPatient">Patient *</label>
                            <select id="appointmentPatient" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentDoctor">Doctor *</label>
                            <select id="appointmentDoctor" required>
                                <option value="">Select Doctor</option>
                                <option value="Dr. Chisanga Bwalya">Dr. Chisanga Bwalya</option>
                                <option value="Dr. Nkandu Mwansa">Dr. Nkandu Mwansa</option>
                                <option value="Dr. Mulenga Chanda">Dr. Mulenga Chanda</option>
                                <option value="Dr. Tembo Kasonde">Dr. Tembo Kasonde</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentDate">Date *</label>
                            <input type="date" id="appointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Time *</label>
                            <input type="time" id="appointmentTime" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentReason">Reason for Visit *</label>
                        <textarea id="appointmentReason" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentStatus">Status</label>
                            <select id="appointmentStatus">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                                <option value="No-show">No-show</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentNotes">Notes</label>
                            <textarea id="appointmentNotes" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <input type="hidden" id="appointmentEditIndex">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger close-modal">Cancel</button>
                <button type="submit" form="appointmentForm" class="btn btn-success">Save Appointment</button>
            </div>
        </div>
    </div>
    
    <!-- Medical Record Modal -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-medical"></i> <span id="recordModalTitle">Add Medical Record</span></h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="recordId">Record ID</label>
                            <input type="text" id="recordId" value="MMGH-R-" readonly>
                        </div>
                        <div class="form-group">
                            <label for="recordPatient">Patient *</label>
                            <select id="recordPatient" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="recordDoctor">Doctor *</label>
                            <select id="recordDoctor" required>
                                <option value="">Select Doctor</option>
                                <option value="Dr. Chisanga Bwalya">Dr. Chisanga Bwalya</option>
                                <option value="Dr. Nkandu Mwansa">Dr. Nkandu Mwansa</option>
                                <option value="Dr. Mulenga Chanda">Dr. Mulenga Chanda</option>
                                <option value="Dr. Tembo Kasonde">Dr. Tembo Kasonde</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="recordDate">Date *</label>
                            <input type="date" id="recordDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="recordDiagnosis">Diagnosis *</label>
                        <textarea id="recordDiagnosis" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="recordTreatment">Treatment</label>
                        <textarea id="recordTreatment" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="recordPrescription">Prescription</label>
                        <textarea id="recordPrescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="recordVitals">Vital Signs</label>
                            <textarea id="recordVitals" rows="2" placeholder="BP: 120/80, Temp: 98.6Â°F, Pulse: 72"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="recordNotes">Additional Notes</label>
                            <textarea id="recordNotes" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <input type="hidden" id="recordEditIndex">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger close-modal">Cancel</button>
                <button type="submit" form="recordForm" class="btn btn-success">Save Record</button>
            </div>
        </div>
    </div>
    
    <!-- Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-nurse"></i> <span id="staffModalTitle">Add Staff Member</span></h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffId">Staff ID</label>
                            <input type="text" id="staffId" value="MMGH-S-" readonly>
                        </div>
                        <div class="form-group">
                            <label for="staffFirstName">First Name *</label>
                            <input type="text" id="staffFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="staffLastName">Last Name *</label>
                            <input type="text" id="staffLastName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffRole">Role *</label>
                            <select id="staffRole" required>
                                <option value="">Select Role</option>
                                <option value="Doctor">Doctor</option>
                                <option value="Nurse">Nurse</option>
                                <option value="Pharmacist">Pharmacist</option>
                                <option value="Lab Technician">Lab Technician</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Support Staff">Support Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="staffDepartment">Department *</label>
                            <select id="staffDepartment" required>
                                <option value="">Select Department</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Surgery">Surgery</option>
                                <option value="Internal Medicine">Internal Medicine</option>
                                <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                <option value="Pharmacy">Pharmacy</option>
                                <option value="Laboratory">Laboratory</option>
                                <option value="Administration">Administration</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffPhone">Phone Number *</label>
                            <input type="tel" id="staffPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="staffEmail">Email</label>
                            <input type="email" id="staffEmail">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffAddress">Address</label>
                            <textarea id="staffAddress" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffJoinDate">Join Date</label>
                            <input type="date" id="staffJoinDate">
                        </div>
                        <div class="form-group">
                            <label for="staffStatus">Status</label>
                            <select id="staffStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="On Leave">On Leave</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="staffEditIndex">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger close-modal">Cancel</button>
                <button type="submit" form="staffForm" class="btn btn-success">Save Staff</button>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Mtendere Mission General Hospital Data Management System &copy; 2023</p>
            <p>For support, contact IT Department at it-support@mtenderehospital.org or call +260 211 123456</p>
        </div>
    </footer>

    <script>
        // Initialize data storage
        let hospitalData = {
            patients: [],
            appointments: [],
            records: [],
            staff: []
        };

        // User authentication state
        let currentUser = null;
        let userRole = null; // 'admin' or 'staff'
        let userToken = null; // JWT token from server

        // Role-based permissions
        const permissions = {
            admin: {
                canEditPatients: true,
                canDeletePatients: true,
                canEditStaff: true,
                canDeleteStaff: true,
                canEditAppointments: true,
                canDeleteAppointments: true,
                canEditRecords: true,
                canDeleteRecords: true,
                canViewAllTabs: true
            },
            staff: {
                canEditPatients: true,
                canDeletePatients: false,
                canEditStaff: false,
                canDeleteStaff: false,
                canEditAppointments: true,
                canDeleteAppointments: false,
                canEditRecords: true,
                canDeleteRecords: false,
                canViewAllTabs: true
            }
        };

        // Check if user has permission
        function hasPermission(action) {
            if (!userRole || !permissions[userRole]) return false;
            return permissions[userRole][action] || false;
        }

        // Toggle between login and signup
        function toggleSignup() {
            document.getElementById('loginPage').style.display = document.getElementById('loginPage').style.display === 'none' ? 'flex' : 'none';
            document.getElementById('signupPage').style.display = document.getElementById('signupPage').style.display === 'none' ? 'flex' : 'none';
        }

        // Toggle password visibility
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = event.target.closest('.password-toggle');
            if (field.type === 'password') {
                field.type = 'text';
                button.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                field.type = 'password';
                button.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        // Sign up handler
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            
            if (password !== confirm) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            const data = {
                username: document.getElementById('signupUsername').value,
                email: document.getElementById('signupEmail').value,
                fullName: document.getElementById('signupFullName').value,
                password: password,
                role: document.getElementById('signupRole').value
            };

            try {
                const res = await fetch('/api/auth/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    showNotification('Sign up successful! Logging in...', 'success');
                    // Auto-login to demo mode after signup
                    currentUser = data.username;
                    userRole = data.role;
                    localStorage.setItem('currentUser', data.username);
                    localStorage.setItem('userRole', data.role);
                    
                    setTimeout(() => {
                        document.getElementById('signupPage').style.display = 'none';
                        document.getElementById('mainApp').classList.add('show');
                        document.getElementById('currentUserName').textContent = data.username;
                        document.getElementById('currentUserRole').textContent = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                        document.getElementById('roleDisplay').textContent = data.role === 'admin' ? 'Administrator' : 'Staff Member';
                        
                        if (userRole === 'admin') {
                            document.getElementById('adminTabContainer').style.display = 'flex';
                        }
                        
                        loadData();
                        updatePermissions();
                        showNotification('Demo mode: Account pending admin approval. You can access with limited features.', 'info');
                    }, 1000);
                } else {
                    showNotification(result.error || 'Sign up failed', 'error');
                }
            } catch (err) {
                // Fallback to demo mode for signup
                showNotification('Signup registered! Logging in...', 'success');
                currentUser = data.username;
                userRole = data.role;
                localStorage.setItem('currentUser', data.username);
                localStorage.setItem('userRole', data.role);
                
                setTimeout(() => {
                    document.getElementById('signupPage').style.display = 'none';
                    document.getElementById('mainApp').classList.add('show');
                    document.getElementById('currentUserName').textContent = data.username;
                    document.getElementById('currentUserRole').textContent = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                    document.getElementById('roleDisplay').textContent = data.role === 'admin' ? 'Administrator' : 'Staff Member';
                    
                    if (userRole === 'admin') {
                        document.getElementById('adminTabContainer').style.display = 'flex';
                    }
                    
                    loadData();
                    updatePermissions();
                    showNotification('Demo mode: Account pending admin approval. You can access with limited features.', 'info');
                }, 1000);
            }
        });

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginRole').value;

            // Check if server is available
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await res.json();

                if (res.ok) {
                    currentUser = username;
                    userRole = result.user.role;
                    userToken = result.token;
                    
                    localStorage.setItem('currentUser', username);
                    localStorage.setItem('userRole', result.user.role);
                    localStorage.setItem('userToken', result.token);
                    
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainApp').classList.add('show');
                    document.getElementById('currentUserName').textContent = username;
                    document.getElementById('currentUserRole').textContent = result.user.role.charAt(0).toUpperCase() + result.user.role.slice(1);
                    document.getElementById('roleDisplay').textContent = result.user.role === 'admin' ? 'Administrator' : 'Staff Member';
                    
                    if (userRole === 'admin') {
                        document.getElementById('adminTabContainer').style.display = 'flex';
                    }
                    
                    loadData();
                    updatePermissions();
                    showNotification(`Welcome ${username}!`, 'success');
                } else {
                    const errorMsg = result.error || 'Login failed';
                    if (errorMsg.includes('pending')) {
                        showNotification('Account pending admin approval. Try again after approval, or use demo mode.', 'warning');
                    } else {
                        showNotification(errorMsg, 'error');
                    }
                }
            } catch (err) {
                // Fallback to demo mode
                currentUser = username;
                userRole = role;
                
                localStorage.setItem('currentUser', username);
                localStorage.setItem('userRole', role);
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').classList.add('show');
                document.getElementById('currentUserName').textContent = username;
                document.getElementById('currentUserRole').textContent = role.charAt(0).toUpperCase() + role.slice(1);
                document.getElementById('roleDisplay').textContent = role === 'admin' ? 'Administrator' : 'Staff Member';
                
                if (userRole === 'admin') {
                    document.getElementById('adminTabContainer').style.display = 'flex';
                }
                
                loadData();
                updatePermissions();
                showNotification(`Demo mode: Welcome ${username}!`);
            }
        });

        // Logout handler
        function logout() {
            currentUser = null;
            userRole = null;
            userToken = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userToken');
            
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('show');
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('loginForm').reset();
            showNotification('Logged out successfully', 'success');
        }

        // Admin functions
        async function loadPendingUsers() {
            try {
                const token = localStorage.getItem('userToken');
                if (!token) return;

                const res = await fetch('/api/admin/pending-users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) return;

                const users = await res.json();
                const container = document.getElementById('pendingUsersList');

                if (users.length === 0) {
                    container.innerHTML = '<p style="color: var(--gray); text-align: center;">No pending approvals</p>';
                    return;
                }

                container.innerHTML = users.map(u => `
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--warning);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="margin: 0; font-weight: 600;">${u.full_name} (${u.username})</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--gray);">${u.email} â¢ ${u.role}</p>
                                <p style="margin: 3px 0 0 0; font-size: 0.85rem; color: var(--gray);">Applied: ${new Date(u.created_at).toLocaleDateString()}</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="approveUser(${u.id})" style="padding: 8px 16px; font-size: 0.9rem;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-danger" onclick="rejectUser(${u.id})" style="padding: 8px 16px; font-size: 0.9rem;">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading pending users:', err);
            }
        }

        async function approveUser(userId) {
            try {
                const token = localStorage.getItem('userToken');
                const res = await fetch(`/api/admin/approve-user/${userId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    showNotification('User approved! Approval email sent.', 'success');
                    loadPendingUsers();
                    loadAllUsers();
                } else {
                    showNotification('Approval failed', 'error');
                }
            } catch (err) {
                console.error('Approval error:', err);
            }
        }

        async function rejectUser(userId) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            try {
                const token = localStorage.getItem('userToken');
                const res = await fetch(`/api/admin/reject-user/${userId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });

                if (res.ok) {
                    showNotification('User rejected. Rejection email sent.', 'success');
                    loadPendingUsers();
                    loadAllUsers();
                } else {
                    showNotification('Rejection failed', 'error');
                }
            } catch (err) {
                console.error('Rejection error:', err);
            }
        }

        async function loadAllUsers() {
            try {
                const token = localStorage.getItem('userToken');
                if (!token) return;

                const res = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) return;

                const users = await res.json();
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td><strong>${u.username}</strong></td>
                        <td>${u.email}</td>
                        <td>${u.full_name}</td>
                        <td><span style="font-weight: 600;">${u.role}</span></td>
                        <td><span class="status ${u.status.toLowerCase()}">${u.status}</span></td>
                        <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        <td>
                            ${u.status === 'approved' ? `<span style="font-size: 0.85rem; color: var(--gray);">Approved ${new Date(u.approved_at).toLocaleDateString()}</span>` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        async function loadAuditLogs() {
            try {
                const token = localStorage.getItem('userToken');
                if (!token) return;

                const res = await fetch('/api/admin/audit-logs?limit=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) return;

                const logs = await res.json();
                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = logs.map(l => `
                    <tr>
                        <td>${new Date(l.created_at).toLocaleString()}</td>
                        <td>${l.username || 'System'}</td>
                        <td><strong>${l.action}</strong></td>
                        <td style="font-size: 0.9rem; color: var(--gray);">${l.table_name || 'â'} ${l.record_id ? ` (${l.record_id})` : ''}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading audit logs:', err);
            }
        }

        function switchAdminTab(tab) {
            document.getElementById('pendingUsersSection').style.display = tab === 'pending-users' ? 'block' : 'none';
            document.getElementById('userManagementSection').style.display = tab === 'user-management' ? 'block' : 'none';
            document.getElementById('auditLogsSection').style.display = tab === 'audit-logs' ? 'block' : 'none';

            if (tab === 'pending-users') loadPendingUsers();
            if (tab === 'user-management') loadAllUsers();
            if (tab === 'audit-logs') loadAuditLogs();
        }

        // Load data from server if available, otherwise localStorage
        async function loadData() {
            try {
                const res = await fetch('/api/data');
                if (res.ok) {
                    const data = await res.json();
                    hospitalData = {
                        patients: data.patients || [],
                        appointments: data.appointments || [],
                        records: data.records || [],
                        staff: data.staff || []
                    };
                    updateStats();
                    renderPatients();
                    renderAppointments();
                    renderRecords();
                    renderStaff();
                    return;
                }
            } catch (err) {
                console.warn('Server load failed, falling back to localStorage', err);
            }

            const savedData = localStorage.getItem('mtendereHospitalData');
            if (savedData) {
                hospitalData = JSON.parse(savedData);
            } else {
                // Initialize with sample data
                hospitalData = {
                    patients: [
                        {id: "MMGH-P-1001", firstName: "John", lastName: "Mwila", dob: "1985-03-12", gender: "Male", phone: "0977123456", address: "123 Lusaka Road", emergencyContact: "Jane Mwila - 0977654321", bloodGroup: "O+", status: "Active"},
                        {id: "MMGH-P-1002", firstName: "Mary", lastName: "Chanda", dob: "1992-07-25", gender: "Female", phone: "0966123789", address: "456 Kitwe Street", emergencyContact: "Peter Chanda - 0966789123", bloodGroup: "A-", status: "Active"},
                        {id: "MMGH-P-1003", firstName: "Peter", lastName: "Banda", dob: "1978-11-05", gender: "Male", phone: "0955112233", address: "789 Ndola Avenue", emergencyContact: "Sarah Banda - 0955332211", bloodGroup: "B+", status: "Active"},
                        {id: "MMGH-P-1004", firstName: "Grace", lastName: "Tembo", dob: "2001-01-30", gender: "Female", phone: "0978445566", address: "321 Livingstone Road", emergencyContact: "James Tembo - 0978665544", bloodGroup: "AB+", status: "Inactive"}
                    ],
                    appointments: [
                        {id: "MMGH-A-2001", patientId: "MMGH-P-1001", patientName: "John Mwila", doctor: "Dr. Chisanga Bwalya", date: getTodayDate(), time: "10:00", reason: "Routine Checkup", status: "Scheduled", notes: "Patient has hypertension history"},
                        {id: "MMGH-A-2002", patientId: "MMGH-P-1002", patientName: "Mary Chanda", doctor: "Dr. Nkandu Mwansa", date: getTodayDate(), time: "11:30", reason: "Pregnancy follow-up", status: "Scheduled", notes: "28 weeks pregnant"},
                        {id: "MMGH-A-2003", patientId: "MMGH-P-1003", patientName: "Peter Banda", doctor: "Dr. Mulenga Chanda", date: getTomorrowDate(), time: "14:00", reason: "Diabetes management", status: "Scheduled", notes: "Check blood sugar levels"},
                        {id: "MMGH-A-2004", patientId: "MMGH-P-1004", patientName: "Grace Tembo", doctor: "Dr. Tembo Kasonde", date: getTodayDate(), time: "09:00", reason: "Fever and cough", status: "Completed", notes: "Prescribed antibiotics"}
                    ],
                    records: [
                        {id: "MMGH-R-3001", patientId: "MMGH-P-1001", patientName: "John Mwila", doctor: "Dr. Chisanga Bwalya", date: "2023-10-15", diagnosis: "Hypertension Stage 1", treatment: "Lifestyle modification, Amlodipine 5mg daily", prescription: "Amlodipine 5mg - 30 tablets", vitals: "BP: 145/90, Temp: 98.6Â°F, Pulse: 78", notes: "Advise low salt diet and regular exercise"},
                        {id: "MMGH-R-3002", patientId: "MMGH-P-1002", patientName: "Mary Chanda", doctor: "Dr. Nkandu Mwansa", date: "2023-10-10", diagnosis: "Normal Pregnancy - 24 weeks", treatment: "Prenatal vitamins, regular checkups", prescription: "Folic Acid, Iron supplements", vitals: "BP: 120/80, Temp: 98.2Â°F, Pulse: 72", notes: "Next ultrasound scheduled for next month"},
                        {id: "MMGH-R-3003", patientId: "MMGH-P-1003", patientName: "Peter Banda", doctor: "Dr. Mulenga Chanda", date: "2023-10-05", diagnosis: "Type 2 Diabetes Mellitus", treatment: "Metformin 500mg twice daily, Diet control", prescription: "Metformin 500mg - 60 tablets", vitals: "BP: 130/85, Temp: 98.4Â°F, Pulse: 76", notes: "Follow up in 2 weeks for blood sugar check"}
                    ],
                    staff: [
                        {id: "MMGH-S-4001", firstName: "Chisanga", lastName: "Bwalya", role: "Doctor", department: "Internal Medicine", phone: "0977001122", email: "c.bwalya@mtenderehospital.org", address: "Hospital Quarters, Block A", joinDate: "2018-03-15", status: "Active"},
                        {id: "MMGH-S-4002", firstName: "Nkandu", lastName: "Mwansa", role: "Doctor", department: "Obstetrics & Gynecology", phone: "0966112233", email: "n.mwansa@mtenderehospital.org", address: "Hospital Quarters, Block B", joinDate: "2020-07-10", status: "Active"},
                        {id: "MMGH-S-4003", firstName: "Mulenga", lastName: "Chanda", role: "Doctor", department: "Endocrinology", phone: "0955223344", email: "m.chanda@mtenderehospital.org", address: "123 Medical Street", joinDate: "2019-11-20", status: "Active"},
                        {id: "MMGH-S-4004", firstName: "Tembo", lastName: "Kasonde", role: "Doctor", department: "Emergency", phone: "0978334455", email: "t.kasonde@mtenderehospital.org", address: "456 Health Avenue", joinDate: "2021-02-05", status: "Active"},
                        {id: "MMGH-S-4005", firstName: "Sarah", lastName: "Kabwe", role: "Nurse", department: "Pediatrics", phone: "0966445566", email: "s.kabwe@mtenderehospital.org", address: "789 Care Road", joinDate: "2022-05-18", status: "Active"},
                        {id: "MMGH-S-4006", firstName: "Joseph", lastName: "Mwale", role: "Pharmacist", department: "Pharmacy", phone: "0955556677", email: "j.mwale@mtenderehospital.org", address: "321 Drug Street", joinDate: "2020-09-12", status: "Active"}
                    ]
                };
                saveData();
            }
            updateStats();
            renderPatients();
            renderAppointments();
            renderRecords();
            renderStaff();
            addExportImportButtons();
        }

        // Save data to server (bulk) or fallback to localStorage
        async function saveData() {
            try {
                const res = await fetch('/api/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(hospitalData)
                });
                if (res.ok) {
                    updateStats();
                    return;
                }
            } catch (err) {
                console.warn('Server save failed, saving locally', err);
            }

            localStorage.setItem('mtendereHospitalData', JSON.stringify(hospitalData));
            updateStats();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('patientCount').textContent = hospitalData.patients.length;
            
            const today = getTodayDate();
            const todayAppointments = hospitalData.appointments.filter(app => app.date === today);
            document.getElementById('appointmentCount').textContent = todayAppointments.length;
            
            document.getElementById('staffCount').textContent = hospitalData.staff.length;
        }

        // Helper functions for dates
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getTomorrowDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // Generate unique IDs with auto-increment
        function generateId(prefix) {
            if (prefix === 'patients') {
                const lastPatientNum = hospitalData.patients.length > 0 
                    ? parseInt(hospitalData.patients[hospitalData.patients.length - 1].id.split('-')[2]) 
                    : 1000;
                return `MMGH-P-${lastPatientNum + 1}`;
            }
            const items = hospitalData[prefix];
            const prefixMap = { appointments: 'A', records: 'R', staff: 'S' };
            const lastId = items.length > 0 ? parseInt(items[items.length - 1].id.split('-').pop()) : 0;
            return `MMGH-${prefixMap[prefix]}-${(lastId + 1).toString().padStart(4, '0')}`;
        }

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Modal functionality
        const modals = document.querySelectorAll('.modal');
        const closeModalBtns = document.querySelectorAll('.close-modal');

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                modal.style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Patient management
        document.getElementById('addPatientBtn').addEventListener('click', function() {
            if (!hasPermission('canEditPatients')) {
                showNotification('You do not have permission to add patients', 'error');
                return;
            }
            document.getElementById('patientModalTitle').textContent = 'Add New Patient';
            const newId = generateId('patients');
            document.getElementById('patientId').value = newId;
            document.getElementById('patientId').disabled = true;
            document.getElementById('patientForm').reset();
            document.getElementById('patientId').value = newId;
            document.getElementById('patientEditIndex').value = '';
            openModal('patientModal');
        });

        // Patient form submission
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = document.getElementById('patientEditIndex').value;
            const patientData = {
                id: document.getElementById('patientId').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                status: "Active"
            };
            
            if (editIndex !== '') {
                // Update existing patient
                hospitalData.patients[editIndex] = patientData;
            } else {
                // Add new patient
                hospitalData.patients.push(patientData);
            }
            
            saveData();
            renderPatients();
            closeModal('patientModal');
            showNotification(`Patient ${editIndex !== '' ? 'updated' : 'added'} successfully!`);
        });

        // Render patients table
        function renderPatients(filter = '') {
            const tableBody = document.getElementById('patientsTableBody');
            tableBody.innerHTML = '';
            
            const filteredPatients = hospitalData.patients.filter(patient => {
                const searchStr = filter.toLowerCase();
                return (
                    patient.firstName.toLowerCase().includes(searchStr) ||
                    patient.lastName.toLowerCase().includes(searchStr) ||
                    patient.id.toLowerCase().includes(searchStr) ||
                    patient.phone.includes(searchStr)
                );
            });
            
            filteredPatients.forEach((patient, index) => {
                const age = calculateAge(patient.dob);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.firstName} ${patient.lastName}</td>
                    <td>${age}</td>
                    <td>${patient.gender}</td>
                    <td>${patient.phone}</td>
                    <td><span class="status ${patient.status.toLowerCase()}">${patient.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewPatient(${index})"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit-btn" onclick="editPatient(${index})"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deletePatient(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Patient actions
        function viewPatient(index) {
            const patient = hospitalData.patients[index];
            alert(`Patient Details:\n\nID: ${patient.id}\nName: ${patient.firstName} ${patient.lastName}\nDOB: ${patient.dob}\nAge: ${calculateAge(patient.dob)}\nGender: ${patient.gender}\nPhone: ${patient.phone}\nAddress: ${patient.address}\nEmergency Contact: ${patient.emergencyContact}\nBlood Group: ${patient.bloodGroup}\nStatus: ${patient.status}`);
        }

        function editPatient(index) {
            const patient = hospitalData.patients[index];
            document.getElementById('patientModalTitle').textContent = 'Edit Patient';
            document.getElementById('patientId').value = patient.id;
            document.getElementById('firstName').value = patient.firstName;
            document.getElementById('lastName').value = patient.lastName;
            document.getElementById('dob').value = patient.dob;
            document.getElementById('gender').value = patient.gender;
            document.getElementById('phone').value = patient.phone;
            document.getElementById('address').value = patient.address;
            document.getElementById('emergencyContact').value = patient.emergencyContact;
            document.getElementById('bloodGroup').value = patient.bloodGroup;
            document.getElementById('patientEditIndex').value = index;
            
            openModal('patientModal');
        }

        function deletePatient(index) {
            if (!hasPermission('canDeletePatients')) {
                showNotification('You do not have permission to delete patients', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this patient?')) {
                hospitalData.patients.splice(index, 1);
                saveData();
                renderPatients();
                showNotification('Patient deleted successfully!');
            }
        }

        // Appointment management
        document.getElementById('addAppointmentBtn').addEventListener('click', function() {
            document.getElementById('appointmentModalTitle').textContent = 'Schedule Appointment';
            document.getElementById('appointmentId').value = generateId('appointments');
            
            // Populate patient dropdown
            const patientSelect = document.getElementById('appointmentPatient');
            patientSelect.innerHTML = '<option value="">Select Patient</option>';
            hospitalData.patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.firstName} ${patient.lastName} (${patient.id})`;
                patientSelect.appendChild(option);
            });
            
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentDate').value = getTodayDate();
            document.getElementById('appointmentTime').value = '09:00';
            document.getElementById('appointmentEditIndex').value = '';
            openModal('appointmentModal');
        });

        // Appointment form submission
        document.getElementById('appointmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = document.getElementById('appointmentEditIndex').value;
            const patientId = document.getElementById('appointmentPatient').value;
            const patient = hospitalData.patients.find(p => p.id === patientId);
            
            const appointmentData = {
                id: document.getElementById('appointmentId').value,
                patientId: patientId,
                patientName: patient ? `${patient.firstName} ${patient.lastName}` : 'Unknown Patient',
                doctor: document.getElementById('appointmentDoctor').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                reason: document.getElementById('appointmentReason').value,
                status: document.getElementById('appointmentStatus').value,
                notes: document.getElementById('appointmentNotes').value
            };
            
            if (editIndex !== '') {
                // Update existing appointment
                hospitalData.appointments[editIndex] = appointmentData;
            } else {
                // Add new appointment
                hospitalData.appointments.push(appointmentData);
            }
            
            saveData();
            renderAppointments();
            closeModal('appointmentModal');
            showNotification(`Appointment ${editIndex !== '' ? 'updated' : 'scheduled'} successfully!`);
        });

        // Render appointments table
        function renderAppointments(filter = '') {
            const tableBody = document.getElementById('appointmentsTableBody');
            tableBody.innerHTML = '';
            
            const filteredAppointments = hospitalData.appointments.filter(appointment => {
                const searchStr = filter.toLowerCase();
                return (
                    appointment.patientName.toLowerCase().includes(searchStr) ||
                    appointment.id.toLowerCase().includes(searchStr) ||
                    appointment.doctor.toLowerCase().includes(searchStr) ||
                    appointment.date.includes(searchStr) ||
                    appointment.reason.toLowerCase().includes(searchStr)
                );
            });
            
            // Sort by date and time
            filteredAppointments.sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.time}`);
                const dateTimeB = new Date(`${b.date}T${b.time}`);
                return dateTimeA - dateTimeB;
            });
            
            filteredAppointments.forEach((appointment, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${appointment.id}</td>
                    <td>${appointment.patientName}</td>
                    <td>${appointment.doctor}</td>
                    <td>${appointment.date} at ${appointment.time}</td>
                    <td>${appointment.reason}</td>
                    <td><span class="status ${appointment.status.toLowerCase().replace('-', '')}">${appointment.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editAppointment(${index})"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteAppointment(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Appointment actions
        function editAppointment(index) {
            const appointment = hospitalData.appointments[index];
            document.getElementById('appointmentModalTitle').textContent = 'Edit Appointment';
            
            // Populate patient dropdown
            const patientSelect = document.getElementById('appointmentPatient');
            patientSelect.innerHTML = '<option value="">Select Patient</option>';
            hospitalData.patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.firstName} ${patient.lastName} (${patient.id})`;
                if (patient.id === appointment.patientId) option.selected = true;
                patientSelect.appendChild(option);
            });
            
            document.getElementById('appointmentId').value = appointment.id;
            document.getElementById('appointmentDoctor').value = appointment.doctor;
            document.getElementById('appointmentDate').value = appointment.date;
            document.getElementById('appointmentTime').value = appointment.time;
            document.getElementById('appointmentReason').value = appointment.reason;
            document.getElementById('appointmentStatus').value = appointment.status;
            document.getElementById('appointmentNotes').value = appointment.notes;
            document.getElementById('appointmentEditIndex').value = index;
            
            openModal('appointmentModal');
        }

        function deleteAppointment(index) {
            if (!hasPermission('canDeleteAppointments')) {
                showNotification('You do not have permission to delete appointments', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this appointment?')) {
                hospitalData.appointments.splice(index, 1);
                saveData();
                renderAppointments();
                showNotification('Appointment deleted successfully!');
            }
        }

        // Medical Record management
        document.getElementById('addRecordBtn').addEventListener('click', function() {
            document.getElementById('recordModalTitle').textContent = 'Add Medical Record';
            document.getElementById('recordId').value = generateId('records');
            
            // Populate patient dropdown
            const patientSelect = document.getElementById('recordPatient');
            patientSelect.innerHTML = '<option value="">Select Patient</option>';
            hospitalData.patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.firstName} ${patient.lastName} (${patient.id})`;
                patientSelect.appendChild(option);
            });
            
            document.getElementById('recordForm').reset();
            document.getElementById('recordDate').value = getTodayDate();
            document.getElementById('recordEditIndex').value = '';
            openModal('recordModal');
        });

        // Record form submission
        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = document.getElementById('recordEditIndex').value;
            const patientId = document.getElementById('recordPatient').value;
            const patient = hospitalData.patients.find(p => p.id === patientId);
            
            const recordData = {
                id: document.getElementById('recordId').value,
                patientId: patientId,
                patientName: patient ? `${patient.firstName} ${patient.lastName}` : 'Unknown Patient',
                doctor: document.getElementById('recordDoctor').value,
                date: document.getElementById('recordDate').value,
                diagnosis: document.getElementById('recordDiagnosis').value,
                treatment: document.getElementById('recordTreatment').value,
                prescription: document.getElementById('recordPrescription').value,
                vitals: document.getElementById('recordVitals').value,
                notes: document.getElementById('recordNotes').value
            };
            
            if (editIndex !== '') {
                // Update existing record
                hospitalData.records[editIndex] = recordData;
            } else {
                // Add new record
                hospitalData.records.push(recordData);
            }
            
            saveData();
            renderRecords();
            closeModal('recordModal');
            showNotification(`Medical record ${editIndex !== '' ? 'updated' : 'added'} successfully!`);
        });

        // Render records table
        function renderRecords(filter = '') {
            const tableBody = document.getElementById('recordsTableBody');
            tableBody.innerHTML = '';
            
            const filteredRecords = hospitalData.records.filter(record => {
                const searchStr = filter.toLowerCase();
                return (
                    record.patientName.toLowerCase().includes(searchStr) ||
                    record.id.toLowerCase().includes(searchStr) ||
                    record.doctor.toLowerCase().includes(searchStr) ||
                    record.diagnosis.toLowerCase().includes(searchStr) ||
                    record.date.includes(searchStr)
                );
            });
            
            // Sort by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${record.patientName}</td>
                    <td>${record.diagnosis.length > 50 ? record.diagnosis.substring(0, 50) + '...' : record.diagnosis}</td>
                    <td>${record.doctor}</td>
                    <td>${record.date}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewRecord(${index})"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit-btn" onclick="editRecord(${index})"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteRecord(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Record actions
        function viewRecord(index) {
            const record = hospitalData.records[index];
            alert(`Medical Record Details:\n\nRecord ID: ${record.id}\nPatient: ${record.patientName}\nDoctor: ${record.doctor}\nDate: ${record.date}\n\nDiagnosis:\n${record.diagnosis}\n\nTreatment:\n${record.treatment}\n\nPrescription:\n${record.prescription}\n\nVital Signs:\n${record.vitals}\n\nNotes:\n${record.notes}`);
        }

        function editRecord(index) {
            const record = hospitalData.records[index];
            document.getElementById('recordModalTitle').textContent = 'Edit Medical Record';
            
            // Populate patient dropdown
            const patientSelect = document.getElementById('recordPatient');
            patientSelect.innerHTML = '<option value="">Select Patient</option>';
            hospitalData.patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.firstName} ${patient.lastName} (${patient.id})`;
                if (patient.id === record.patientId) option.selected = true;
                patientSelect.appendChild(option);
            });
            
            document.getElementById('recordId').value = record.id;
            document.getElementById('recordDoctor').value = record.doctor;
            document.getElementById('recordDate').value = record.date;
            document.getElementById('recordDiagnosis').value = record.diagnosis;
            document.getElementById('recordTreatment').value = record.treatment;
            document.getElementById('recordPrescription').value = record.prescription;
            document.getElementById('recordVitals').value = record.vitals;
            document.getElementById('recordNotes').value = record.notes;
            document.getElementById('recordEditIndex').value = index;
            
            openModal('recordModal');
        }

        function deleteRecord(index) {
            if (!hasPermission('canDeleteRecords')) {
                showNotification('You do not have permission to delete medical records', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this medical record?')) {
                hospitalData.records.splice(index, 1);
                saveData();
                renderRecords();
                showNotification('Medical record deleted successfully!');
            }
        }

        // Staff management
        document.getElementById('addStaffBtn').addEventListener('click', function() {
            document.getElementById('staffModalTitle').textContent = 'Add Staff Member';
            document.getElementById('staffId').value = generateId('staff');
            document.getElementById('staffForm').reset();
            document.getElementById('staffJoinDate').value = getTodayDate();
            document.getElementById('staffEditIndex').value = '';
            openModal('staffModal');
        });

        // Staff form submission
        document.getElementById('staffForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = document.getElementById('staffEditIndex').value;
            const staffData = {
                id: document.getElementById('staffId').value,
                firstName: document.getElementById('staffFirstName').value,
                lastName: document.getElementById('staffLastName').value,
                role: document.getElementById('staffRole').value,
                department: document.getElementById('staffDepartment').value,
                phone: document.getElementById('staffPhone').value,
                email: document.getElementById('staffEmail').value,
                address: document.getElementById('staffAddress').value,
                joinDate: document.getElementById('staffJoinDate').value,
                status: document.getElementById('staffStatus').value
            };
            
            if (editIndex !== '') {
                // Update existing staff
                hospitalData.staff[editIndex] = staffData;
            } else {
                // Add new staff
                hospitalData.staff.push(staffData);
            }
            
            saveData();
            renderStaff();
            closeModal('staffModal');
            showNotification(`Staff member ${editIndex !== '' ? 'updated' : 'added'} successfully!`);
        });

        // Render staff table
        function renderStaff(filter = '') {
            const tableBody = document.getElementById('staffTableBody');
            tableBody.innerHTML = '';
            
            const filteredStaff = hospitalData.staff.filter(staff => {
                const searchStr = filter.toLowerCase();
                return (
                    staff.firstName.toLowerCase().includes(searchStr) ||
                    staff.lastName.toLowerCase().includes(searchStr) ||
                    staff.id.toLowerCase().includes(searchStr) ||
                    staff.role.toLowerCase().includes(searchStr) ||
                    staff.department.toLowerCase().includes(searchStr)
                );
            });
            
            filteredStaff.forEach((staff, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${staff.id}</td>
                    <td>${staff.firstName} ${staff.lastName}</td>
                    <td>${staff.role}</td>
                    <td>${staff.department}</td>
                    <td>${staff.phone}</td>
                    <td><span class="status ${staff.status.toLowerCase().replace(' ', '')}">${staff.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editStaff(${index})"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteStaff(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Staff actions
        function editStaff(index) {
            const staff = hospitalData.staff[index];
            document.getElementById('staffModalTitle').textContent = 'Edit Staff Member';
            document.getElementById('staffId').value = staff.id;
            document.getElementById('staffFirstName').value = staff.firstName;
            document.getElementById('staffLastName').value = staff.lastName;
            document.getElementById('staffRole').value = staff.role;
            document.getElementById('staffDepartment').value = staff.department;
            document.getElementById('staffPhone').value = staff.phone;
            document.getElementById('staffEmail').value = staff.email;
            document.getElementById('staffAddress').value = staff.address;
            document.getElementById('staffJoinDate').value = staff.joinDate;
            document.getElementById('staffStatus').value = staff.status;
            document.getElementById('staffEditIndex').value = index;
            
            openModal('staffModal');
        }

        function deleteStaff(index) {
            if (!hasPermission('canDeleteStaff')) {
                showNotification('You do not have permission to delete staff members', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this staff member?')) {
                hospitalData.staff.splice(index, 1);
                saveData();
                renderStaff();
                showNotification('Staff member deleted successfully!');
            }
        }

        // Search functionality
        document.getElementById('searchPatient').addEventListener('input', function() {
            renderPatients(this.value);
        });
        
        document.getElementById('searchAppointment').addEventListener('input', function() {
            renderAppointments(this.value);
        });
        
        document.getElementById('searchRecord').addEventListener('input', function() {
            renderRecords(this.value);
        });
        
        document.getElementById('searchStaff').addEventListener('input', function() {
            renderStaff(this.value);
        });

        // Notification function
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background-color: ${type === 'success' ? '#d4edda' : '#f8d7da'};
                color: ${type === 'success' ? '#155724' : '#721c24'};
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                z-index: 9999;
                font-weight: 600;
                animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
                border-left: 4px solid ${type === 'success' ? '#28a745' : '#dc3545'};
            `;
            
            // Add animation keyframes
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Export data function
        function exportData() {
            const dataStr = JSON.stringify(hospitalData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `mtendere-hospital-data-${getTodayDate()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported successfully!');
        }

        // Import data function
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    hospitalData = importedData;
                    saveData();
                    loadData();
                    showNotification('Data imported successfully!');
                } catch (error) {
                    showNotification('Error importing data. Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Add export/import buttons to the UI
        function addExportImportButtons() {
            const headerContent = document.querySelector('.header-content');
            if (!headerContent) return; // Only run if mainApp is visible
            
            const existingDiv = headerContent.querySelector('div:last-child');
            if (existingDiv && existingDiv.style.display === 'flex') return; // Already added
            
            const exportImportDiv = document.createElement('div');
            exportImportDiv.style.cssText = 'display: flex; gap: 10px; margin-top: 10px;';
            
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-success';
            exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Export Data';
            exportBtn.onclick = exportData;
            
            const importBtn = document.createElement('button');
            importBtn.className = 'btn btn-primary';
            importBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Data';
            
            const importInput = document.createElement('input');
            importInput.type = 'file';
            importInput.accept = '.json';
            importInput.style.display = 'none';
            importInput.onchange = importData;
            
            importBtn.onclick = function() {
                importInput.click();
            };
            
            exportImportDiv.appendChild(exportBtn);
            exportImportDiv.appendChild(importBtn);
            exportImportDiv.appendChild(importInput);
            
            headerContent.appendChild(exportImportDiv);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Set today's date as default in appointment modal
            document.getElementById('appointmentDate').value = getTodayDate();
            
            // Initialize search functionality
            document.getElementById('searchPatient').addEventListener('input', function() {
                renderPatients(this.value);
            });
        });
    </script>
</body>
</html>